"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var _react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_createReactClass=_interopRequireDefault(require("create-react-class")),_pydio=_interopRequireDefault(require("pydio")),_styles=require("material-ui/styles"),_reactRedux=require("react-redux"),_redux=require("redux"),_materialUi=require("material-ui"),_path=_interopRequireDefault(require("pydio/util/path")),_dom=_interopRequireDefault(require("pydio/util/dom"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var r,i=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)),i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,i=arguments[t];for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,i?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var _require=require("react-textfit"),Textfit=_require.Textfit,Color=require("color"),_Pydio$requireLib=_pydio.default.requireLib("workspaces"),Breadcrumb=_Pydio$requireLib.Breadcrumb,SearchForm=_Pydio$requireLib.SearchForm,MainFilesList=_Pydio$requireLib.MainFilesList,Editor=_Pydio$requireLib.Editor,EditionPanel=_Pydio$requireLib.EditionPanel,_Pydio$requireLib2=_pydio.default.requireLib("components"),ContextMenu=_Pydio$requireLib2.ContextMenu,IconButtonMenu=_Pydio$requireLib2.IconButtonMenu,Toolbar=_Pydio$requireLib2.Toolbar,ListPaginator=_Pydio$requireLib2.ListPaginator,ClipboardTextField=_Pydio$requireLib2.ClipboardTextField,_Pydio$requireLib3=_pydio.default.requireLib("boot"),withProgressiveBg=_Pydio$requireLib3.withProgressiveBg,_Pydio$requireLib4=_pydio.default.requireLib("hoc"),EditorActions=_Pydio$requireLib4.EditorActions,dropProvider=_Pydio$requireLib4.dropProvider,withUniqueNode=function(i){return function(r){return function(){_inherits(t,_react["default"].PureComponent);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"componentDidMount",value:function(){this.detectFirstNode()}},{key:"detectFirstNode",value:function(){var e,t=this,r=this.props.pydio.getContextHolder();r.getSelectedNodes().length?this.state&&this.state.node||this.setState({node:r.getSelectedNodes()[0]}):(e=r.getRootNode().getFirstChildIfExists())?(r.setSelectedNodes([e],"dataModel"),this.setState({node:e})):setTimeout(function(){return t.detectFirstNode()},1e3),i&&r.observe("selection_changed",function(){var e=r.getSelectedNodes();e.length?this.setState({node:e[0]}):this.setState({node:null})}.bind(this))}},{key:"render",value:function(){return _react.default.createElement(r,_extends({},this.props,this.state))}}]),t}()}},withRepositoriesListener=function(){return function(e){return function(){_inherits(i,_react["default"].PureComponent);var r=_createSuper(i);function i(e){_classCallCheck(this,i);var t=r.call(this,e),e=e.pydio;return t.state={emptyUser:!e.user},t}return _createClass(i,[{key:"componentDidMount",value:function(){var e=this,t=this.props.pydio;this._obs=function(){return e.setState({emptyUser:!t.user})},t.observe("repository_list_refreshed",this._obs)}},{key:"componentWillUnmount",value:function(){this.props.pydio.stopObserving("repository_list_refreshed",this._obs)}},{key:"render",value:function(){return _react.default.createElement(e,_extends({},this.props,this.state))}}]),i}()}},ConfigLogo=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"render",value:function(){var e,t=this.props.pydio,r=t.Registry.getPluginConfigs("action.advanced_settings").get("CUSTOM_MINISITE_LOGO");return(r=r||t.Parameters.get("ajxpResourcesFolder")+"/themes/common/images/PydioLogoSquare.png")&&(e=0===r.indexOf("plug/")?r:t.Parameters.get("ENDPOINT_REST_API")+"/frontend/binaries/GLOBAL/"+r),_react.default.createElement("img",{src:e,style:this.props.style})}}]),t}(),Copyright=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"render",value:function(){var e,t=this.props,r=t.mode,i=t.style;return"false"===t.aboutString?null:("insert"===r?e={textAlign:"right",padding:"6px 16px",backgroundColor:"#f7f7f7",color:"black"}:"overlay"===r?e={position:"absolute",bottom:0,right:0,color:"rgba(255,255,255,0.8)",padding:"6px 16px"}:"block"===r&&(e={textAlign:"center",padding:"6px 16px",color:"rgba(255,255,255)"}),_react.default.createElement("div",{style:_objectSpread(_objectSpread({},e),i)},_react.default.createElement("a",{href:"https://pydio.com",style:{fontWeight:500,color:e.color}},"Pydio Cells")," - secure file sharing"))}}]),t}(),StandardLayout=(0,_createReactClass.default)({displayName:"StandardLayout",childContextTypes:{messages:_propTypes.default.object,getMessage:_propTypes.default.func,showSearchForm:_propTypes.default.bool},getChildContext:function(){var e=this.props.pydio.MessageHash;return{messages:e,getMessage:function(t){try{return e[t]||t}catch(e){return t}}}},getDefaultProps:function(){return{minisiteMode:"embed",uniqueNode:!0}},render:function(){var e={appBarStyle:{zIndex:1,backgroundColor:this.props.muiTheme.palette.primary1Color,display:"flex",alignItems:"center"},buttonsStyle:{color:Color(this.props.muiTheme.appBar.textColor).alpha(.8).toString()}},t=this.props,r=t.showSearchForm,i=t.uniqueNode,o=t.skipDisplayToolbar,a=t.bgStyle;if(t.emptyUser)return _react.default.createElement("div",{className:"vertical_fit vertical_layout",style:a});t=[];return i?t.push("minisite_toolbar"):(t.push("info_panel"),o||t.push("display_toolbar")),_react.default.createElement("div",{className:"vertical_fit vertical_layout",style:a},_react.default.createElement(_materialUi.Paper,{zDepth:1,rounded:!1,style:e.appBarStyle},_react.default.createElement(ConfigLogo,{pydio:this.props.pydio,style:{height:50}}),_react.default.createElement("div",{id:"workspace_toolbar",style:{display:"flex",flex:1,overflow:"hidden"}},_react.default.createElement(Breadcrumb,_extends({},this.props,{rootStyle:{padding:"0 14px",height:36,lineHeight:"36px",maxWidth:null}})),r&&_react.default.createElement(SearchForm,_extends({},this.props,{uniqueSearchScope:"ws",style:{marginTop:5}}))),_react.default.createElement("div",{style:{position:"relative"}},_react.default.createElement("div",{id:"main_toolbar",style:{display:"flex",padding:"0 8px"}},!i&&_react.default.createElement(IconButtonMenu,_extends({},this.props,{id:"create-button-menu",toolbars:["upload","create"],buttonTitle:this.props.pydio.MessageHash[198],buttonClassName:"mdi mdi-folder-plus",buttonStyle:{color:"white"},controller:this.props.pydio.Controller})),_react.default.createElement("div",{style:{flex:1}}),_react.default.createElement(ListPaginator,{id:"paginator-toolbar",dataModel:this.props.pydio.getContextHolder(),toolbarDisplay:!0}),_react.default.createElement(Toolbar,_extends({},this.props,{id:"main-toolbar",toolbars:t,groupOtherList:i?[]:["change_main","more","change","remote"],renderingType:"icon-font",buttonStyle:e.buttonsStyle}))))),this.props.children,_react.default.createElement("span",{className:"context-menu"},_react.default.createElement(ContextMenu,{pydio:this.props.pydio})))}}),StandardLayout=withProgressiveBg(StandardLayout);StandardLayout=dropProvider(StandardLayout);var DLTemplate=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"triggerDL",value:function(){this.setState({downloadStarted:!0}),setTimeout(function(){this.props.pydio.Controller.fireAction("download"),setTimeout(function(){this.setState({downloadStarted:!1})}.bind(this),1500)}.bind(this),100)}},{key:"componentDidMount",value:function(){var e=this.props.pydio;e.user&&e.user.activeRepository?this.setState({repoObject:e.user.repositories.get(e.user.activeRepository)}):e.observe("repository_list_refreshed",function(e){var t=e.list,e=e.active;t&&t.has(e)&&(e=t.get(e),this.setState({repoObject:e}))}.bind(this))}},{key:"render",value:function(){var e,t=this,r=this.props,i=r.bgStyle,o=r.node,a=r.emptyUser,r={main:_objectSpread(_objectSpread({},i),{},{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%"}),block:{cursor:"pointer",width:300,margin:"0 auto",textAlign:"center",background:"rgba(255, 255, 255, 0.91)",padding:20,borderRadius:4,boxShadow:"0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23)"},logo:{width:230,margin:"-50px auto 0"},filename:{fontSize:22,lineHeight:"22px",wordBreak:"break-all"},fileIcon:{fontSize:180,color:this.props.muiTheme.palette.primary1Color},dlIcon:{position:"absolute",top:90,left:80,fontSize:60,color:"#f4f4f4",transition:_dom.default.getBeziersTransition()}};if(a)return _react.default.createElement("div",{className:"vertical_fit",style:_objectSpread(_objectSpread({},r.main),{},{width:"100%"})});this.state&&this.state.repoObject&&(e=this.state.repoObject.getLabel());i=null,a=_react.default.createElement("div",{style:{fontSize:13,lineHeight:"18px"}},this.props.pydio.MessageHash[466]);o&&(i=this.triggerDL.bind(this),s=o.getMetadata().get("bytesize"),a=_react.default.createElement("div",{style:{fontSize:13,lineHeight:"18px",color:"rgba(0,0,0,.43)"}},_react.default.createElement("div",{style:{display:"flex"}},_react.default.createElement("div",{style:{flex:1,textAlign:"right",paddingRight:6,fontWeight:500}},this.props.pydio.MessageHash[503]),_react.default.createElement("div",{style:{flex:1,textAlign:"left",color:"rgba(0,0,0,.73)"}},_path.default.roundFileSize(s))),_react.default.createElement("div",{style:{fontSize:12,marginTop:10}},this.props.pydio.MessageHash["share_center.231"]))),this.state&&this.state.downloadStarted&&(r.dlIcon.opacity=.3);var n,s=this.props.pydio.Controller.getActionByName("share_current_page");return s&&!s.deny&&(n=_react.default.createElement("a",{style:{display:"block",textAlign:"center",padding:12,cursor:"pointer"},onClick:function(){t.setState({displayShareLink:!0})}},s.options.text)),_react.default.createElement("div",{style:r.main},_react.default.createElement(ConfigLogo,{pydio:this.props.pydio,style:r.logo}),_react.default.createElement("div",{className:["download-block"].join(" "),onClick:i,style:r.block},_react.default.createElement("span",{style:r.filename},_react.default.createElement(Textfit,{min:12,max:25,perfectFit:!1,mode:"single"},e)),_react.default.createElement("div",{style:{width:220,margin:"0 auto",position:"relative"}},_react.default.createElement("span",{style:r.fileIcon,className:"mdi mdi-file"}),_react.default.createElement("span",{style:r.dlIcon,className:"mdi mdi-download"})),a),this.state&&this.state.displayShareLink&&_react.default.createElement("div",{style:{width:267,margin:"10px auto",backgroundColor:"rgba(255, 255, 255, 0.85)",padding:"0px 10px",borderRadius:2}},_react.default.createElement(ClipboardTextField,{floatingLabelText:s.options.text,inputValue:document.location.href,getMessage:function(e){return t.props.pydio.MessageHash[e]},buttonStyle:{right:-8,bottom:9}})),_react.default.createElement(Copyright,_extends({mode:"block"},this.props)),!(this.state&&this.state.displayShareLink)&&n)}}]),t}(),FolderMinisite=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"render",value:function(){return _react.default.createElement(StandardLayout,_extends({},this.props,{uniqueNode:!1,showSearchForm:this.props.pydio.getPluginConfigs("action.share").get("SHARED_FOLDER_SHOW_SEARCH")}),_react.default.createElement("div",{style:{backgroundColor:"white"},className:"layout-fill vertical-layout"},_react.default.createElement(MainFilesList,_extends({ref:"list"},this.props,{dataModel:this.props.pydio.getContextHolder()})),_react.default.createElement(Copyright,_extends({mode:"insert"},this.props))),_react.default.createElement(EditionPanel,this.props))}}]),t}(),FileMinisite=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"componentWillReceiveProps",value:function(e){var t,r=this,i=e.pydio,o=e.node,a=e.dispatch;o&&(i.UI.registerEditorOpener(this),e=_path.default.getAjxpMimeType(o),(e=i.Registry.findEditorsForMime(e,!1)).length&&e[0].openable&&(t=e[0],i.Registry.loadEditorResources(t.resourcesManager,function(){var e=null;(e=FuncUtils.getFunctionByName(t.editorClass,window))?(e=a(EditorActions.tabCreate({id:o.getLabel(),title:o.getLabel(),url:o.getPath(),icon:PydioWorkspaces.FilePreview,Editor:e.Editor,Controls:e.Controls,metadata:o.getMetadata(),readonly:"true"===o.getMetadata().get("node_readonly"),pydio:i,node:o,editorData:t,registry:i.Registry})).id,a(EditorActions.editorSetActiveTab(e))):r.setState({error:"Cannot find editor component ("+t.editorClass+")!"})})))}},{key:"openEditorForNode",value:function(t,r){var i=this,o=this.props.dispatch;pydio.Registry.loadEditorResources(r.resourcesManager,function(){var e;(e=FuncUtils.getFunctionByName(r.editorClass,window))?o(EditorActions.tabModify({id:t.getLabel(),title:t.getLabel(),url:t.getPath(),icon:PydioWorkspaces.FilePreview,Editor:e.Editor,Controls:e.Controls,metadata:t.getMetadata(),readonly:"true"===t.getMetadata().get("node_readonly"),pydio:pydio,node:t,editorData:r,registry:pydio.Registry})):i.setState({error:"Cannot find editor component ("+r.editorClass+")!"})})}},{key:"componentWillUnmount",value:function(){pydio.UI.unregisterEditorOpener(this)}},{key:"render",value:function(){return _react.default.createElement(StandardLayout,_extends({},this.props,{uniqueNode:!0,skipDisplayToolbar:!0}),_react.default.createElement("div",{className:"editor_container vertical_layout vertical_fit",style:{backgroundColor:"#424242"}},_react.default.createElement(Editor,{displayToolbar:!1,style:{display:"flex",flex:1}}),_react.default.createElement(Copyright,_extends({mode:"overlay"},this.props))))}}]),t}(),DropZoneMinisite=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"render",value:function(){return _react.default.createElement(StandardLayout,this.props,_react.default.createElement("div",{className:"vertical_fit vertical_layout",style:{backgroundColor:"white"}},_react.default.createElement("div",{className:"vertical_fit vertical_layout",style:{margin:16,marginBottom:2,border:"2px dashed #CFD8DC",borderRadius:4}},_react.default.createElement(MainFilesList,_extends({ref:"list",dataModel:this.props.pydio.getContextHolder()},this.props))),_react.default.createElement(Copyright,_extends({mode:"insert",style:{backgroundColor:"white"}},this.props))),_react.default.createElement(EditionPanel,this.props))}}]),t}(),FilmStripMinisite=function(){_inherits(t,_react["default"].Component);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return _createClass(t,[{key:"render",value:function(){return _react.default.createElement(StandardLayout,_extends({},this.props,{uniqueNode:!1,showSearchForm:this.props.pydio.getPluginConfigs("action.share").get("SHARED_FOLDER_SHOW_SEARCH")}),_react.default.createElement("div",{style:{backgroundColor:"white"},className:"layout-fill vertical-layout"},_react.default.createElement(MainFilesList,_extends({ref:"list"},this.props,{dataModel:this.props.pydio.getContextHolder(),displayMode:"masonry"})),_react.default.createElement(Copyright,_extends({mode:"insert"},this.props))),_react.default.createElement(EditionPanel,this.props))}}]),t}();window.ShareTemplates={FolderMinisite:(0,_redux.compose)((0,_styles.muiThemeable)(),withRepositoriesListener())(FolderMinisite),FileMinisite:(0,_redux.compose)(withRepositoriesListener(),withUniqueNode(!1),(0,_styles.muiThemeable)(),(0,_reactRedux.connect)())(FileMinisite),DLTemplate:(0,_redux.compose)((0,_styles.muiThemeable)(),withUniqueNode(!1),withRepositoriesListener())(withProgressiveBg(DLTemplate)),DropZoneMinisite:(0,_redux.compose)((0,_styles.muiThemeable)(),withRepositoriesListener())(DropZoneMinisite),FilmStripMinisite:(0,_redux.compose)(withRepositoriesListener(),withUniqueNode(!0),(0,_styles.muiThemeable)(),(0,_reactRedux.connect)())(FilmStripMinisite)};